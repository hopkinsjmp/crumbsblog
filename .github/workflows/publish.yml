name: Crumbs Blog Publish

# This tells GitHub to listen for the custom event from your Google Script
on:
  repository_dispatch:
    types: [crumbs_publish]

jobs:
  build-and-deploy:
    runs-runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Slugified Filename
        # We create a simple ID-based slug here for the .md file to keep it unique
        run: |
          echo "FILE_ID=${{ github.event.client_payload.fileId }}" >> $GITHUB_ENV

      - name: Save Markdown Source
        # This saves the raw text from Google Docs into your 'content/posts' folder
        run: |
          mkdir -p content/posts
          cat <<EOF > "content/posts/${{ env.FILE_ID }}.md"
          ---
          title: "${{ github.event.client_payload.name }}"
          date: "${{ github.event.client_payload.publishedAt }}"
          ---

          ${{ github.event.client_payload.content }}
          EOF

      - name: Generate HTML Files
        # This runs your Universal Converter script to build the Year/Month folders
        run: |
          npm install
          node scripts/convert-posts.js

      - name: Commit and Push
        # This pushes the new .md file AND the new .html file back to your repo
        run: |
          git config --global user.name "Crumbs Bot"
          git config --global user.email "bot@crumbsblog.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Publish: ${{ github.event.client_payload.name }}"
            git push
          fi
