name: Crumbs Blog Publish

on:
  repository_dispatch:
    types: [crumbs_publish]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Environment
        run: |
          # 1. Generate Year and Month
          YEAR=$(date +'%Y')
          MONTH=$(date +'%m')
          
          # 2. Create a URL-friendly filename from the title
          # This removes special chars, replaces spaces with hyphens, and makes it lowercase
          TITLE_SLUG=$(echo "${{ github.event.client_payload.name }}" | iconv -t ascii//TRANSLIT | sed -r 's/[^a-zA-Z0-9 ]+//g' | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/--/-/g')
          
          echo "DEST_DIR=$YEAR/$MONTH" >> $GITHUB_ENV
          echo "FILE_NAME=$TITLE_SLUG" >> $GITHUB_ENV

      - name: Save Markdown Source
        run: |
          mkdir -p content/posts
          cat <<EOF > "content/posts/${{ env.FILE_NAME }}.md"
          ---
          title: "${{ github.event.client_payload.name }}"
          date: "${{ github.event.client_payload.publishedAt }}"
          ---

          ${{ github.event.client_payload.content }}
          EOF

      - name: Generate HTML and Update Index
        run: |
          # Install dependencies defined in your package.json
          npm install
          
          # Run your existing conversion script
          # (Note: You may need to adjust this script to handle the new .md files)
          npm run convert
          
          # If you have a python script that updates the index/sidebar, run it here:
          # python3 scripts/generate_index.py

      - name: Commit and Push
        run: |
          git config --global user.name "Crumbs Bot"
          git config --global user.email "bot@crumbsblog.com"
          
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Publish: ${{ github.event.client_payload.name }}"
            git push
          fi
