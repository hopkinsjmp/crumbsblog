name: Crumbs Blog Publish

# This tells GitHub to listen for the custom event from your Google Script
on:
  repository_dispatch:
    types: [crumbs_publish]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # Granting write permission so the bot can push files back to the repo
    permissions:
      contents: write
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Post File
        run: |
          # Create the folder if it doesn't exist
          mkdir -p content/posts
          
          # Create a Markdown file using the File ID as the filename
          # We use a 'heredoc' (the EOF block) to write multiple lines at once
          cat <<EOF > "content/posts/${{ github.event.client_payload.fileId }}.md"
          ---
          title: "${{ github.event.client_payload.name }}"
          date: "${{ github.event.client_payload.publishedAt }}"
          fileId: "${{ github.event.client_payload.fileId }}"
          ---

          ${{ github.event.client_payload.content }}
          EOF

      - name: Commit and Push
        run: |
          # Configure a fake user for the commit message
          git config --global user.name "Crumbs Bot"
          git config --global user.email "bot@crumbsblog.com"
          
          # Stage the new file, commit it, and push to the main branch
          git add content/posts/*.md
          
          # Only commit if there are actually changes to avoid errors
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Publish post: ${{ github.event.client_payload.name }}"
            git push
          fi
